<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boeing 737 | 1:1 Avionics & Cyber Physics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&display=swap');

        :root {
            /* Authentic Boeing Avionics Colors */
            --boeing-cyan: #00FFFF;
            --boeing-green: #00FF00;
            --boeing-magenta: #FF00FF;
            --boeing-white: #FFFFFF;
            --boeing-amber: #FFB800;
            --boeing-red: #FF0000;
            --boeing-bg: #0A0A0A;
            --sky-blue: #1C67BA;
            --earth-brown: #663300;
            --glass-glare: rgba(255, 255, 255, 0.04);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            /* Arimo is a great web-safe match for standard aviation sans-serif */
            font-family: 'Arimo', sans-serif;
            background-color: #030712;
            color: var(--boeing-white);
            overflow-x: hidden;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body::-webkit-scrollbar { display: none; }

        #scroll-track { height: 1200vh; position: relative; z-index: 1; }
        #webgl-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }

        #cockpit-wrapper {
            width: 100vw; height: 100vh; display: flex; flex-direction: column;
            justify-content: flex-end; align-items: center; position: fixed; top: 0; left: 0;
            padding-bottom: 25px; pointer-events: none; z-index: 10;
        }

        .fma-callouts {
            position: absolute; top: 15%; font-size: 2.5rem; font-weight: 700;
            letter-spacing: 2px; color: var(--boeing-green); text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            text-transform: uppercase; opacity: 0;
        }

        .displays-container {
            display: flex; gap: 20px; transform: scale(0.9); transform-origin: bottom center;
            background: rgba(10, 12, 16, 0.85); padding: 25px; border-radius: 12px;
            border-top: 2px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.9);
        }

        /* Standard 737 Display Unit Bezel */
        .screen {
            background-color: var(--boeing-bg); border: 18px solid #141414; border-radius: 8px;
            box-shadow: inset 0 0 0 2px #333, inset 0 0 20px rgba(0,0,0,1);
            position: relative; overflow: hidden; width: 360px; height: 440px;
        }
        .screen::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--glass-glare) 0%, transparent 40%, rgba(0,0,0,0.4) 100%);
            z-index: 100; pointer-events: none;
        }

        /* =========================================================
           1:1 PRIMARY FLIGHT DISPLAY (PFD)
        ========================================================= */
        .pfd { display: flex; justify-content: space-between; align-items: center; position: relative; }
        
        /* Background Horizon */
        .attitude-indicator {
            position: absolute; top: 50%; left: 50%; width: 240px; height: 240px;
            transform: translate(-50%, -50%); border-radius: 10px; overflow: hidden; z-index: 1;
        }
        .horizon-cylinder {
            position: absolute; top: -100%; left: -50%; width: 200%; height: 300%;
            background: linear-gradient(to bottom, var(--sky-blue) 0%, var(--sky-blue) 50%, #ffffff 50%, var(--earth-brown) 50.5%, var(--earth-brown) 100%);
            transform-origin: center center;
        }
        .pitch-ladder-svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 140px; height: 600px; overflow: visible; }
        
        /* 737 Aircraft Symbol */
        .aircraft-symbol {
            position: absolute; top: 50%; left: 50%; width: 160px; height: 20px; transform: translate(-50%, -50%); z-index: 10;
        }
        .ac-wing { position: absolute; top: 50%; width: 50px; height: 6px; background-color: #000; border: 2px solid var(--boeing-white); }
        .ac-wing.left { left: 0; border-right: none; }
        .ac-wing.right { right: 0; border-left: none; }
        .ac-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; border: 2px solid var(--boeing-white); background: #000; }

        /* Tapes */
        .tape-container {
            width: 65px; height: 300px; background-color: rgba(60, 65, 70, 0.4);
            border: 2px solid #555; position: relative; overflow: hidden; z-index: 20;
        }
        .tape-strip { position: absolute; width: 100%; top: 50%; transition: transform 0.05s linear; }
        
        .tape-readout-box {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: #000; border: 2px solid var(--boeing-white);
            color: var(--boeing-white); font-size: 1.4rem; font-weight: 700;
            padding: 4px 0; width: 75px; text-align: center; z-index: 30;
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
        }
        .spd-box { left: 0; border-left: none; }
        .alt-box { right: 0; border-right: none; }
        /* Green pointer arrows */
        .spd-box::after { content: ''; position: absolute; top: 50%; right: -8px; transform: translateY(-50%); border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-left: 8px solid var(--boeing-white); }
        .alt-box::after { content: ''; position: absolute; top: 50%; left: -8px; transform: translateY(-50%); border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-right: 8px solid var(--boeing-white); }

        .tick { position: absolute; display: flex; align-items: center; font-size: 14px; font-weight: bold; color: var(--boeing-white); width: 100%; }
        .tick-spd { justify-content: flex-end; padding-right: 8px; border-right: 3px solid var(--boeing-white); }
        .tick-alt { justify-content: flex-flex-start; padding-left: 8px; border-left: 3px solid var(--boeing-white); }

        /* =========================================================
           1:1 NAVIGATION DISPLAY (ND)
        ========================================================= */
        .nd { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .nd-header { width: 100%; display: flex; justify-content: space-between; color: var(--boeing-green); font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .nd-compass-container { width: 280px; height: 280px; position: relative; margin-top: auto; margin-bottom: 20px; overflow: hidden; }
        .nd-compass-ring { width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--boeing-white); position: absolute; }
        .nd-compass-rose { position: absolute; width: 100%; height: 100%; }
        .nd-ac-symbol { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 24px solid var(--boeing-white); z-index: 10; }

        /* =========================================================
           1:1 ENGINE INDICATING SYSTEM (EIS) - Matches Image.png
        ========================================================= */
        .eis { padding: 10px 15px; display: flex; flex-direction: column; }
        .eis-top-row { display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: bold; }
        .eis-top-row span { color: var(--boeing-cyan); }
        .eis-top-row .green { color: var(--boeing-green); }
        
        .n1-row { display: flex; justify-content: space-around; position: relative; margin-top: 15px; }
        .n1-title { position: absolute; top: 50px; width: 100%; text-align: center; color: var(--boeing-cyan); font-size: 1.2rem; font-weight: bold; }
        
        /* High Fidelity Dial Container */
        .dial-container { position: relative; width: 130px; height: 130px; }
        .dial-svg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow: visible; }
        
        /* Boxed Readout (Like image.png) */
        .dial-readout {
            position: absolute; top: 18px; right: -5px; background: #000;
            border: 2px solid var(--boeing-white); color: var(--boeing-white);
            font-size: 1.8rem; font-weight: bold; padding: 0 4px; text-align: right; min-width: 60px;
        }
        
        /* Secondary Engine Parameters Block */
        .secondary-block {
            margin-top: 20px; display: grid; grid-template-columns: 80px 100px 80px;
            justify-content: center; gap: 4px 10px; font-size: 1.1rem; font-weight: bold;
        }
        .sec-lbl { color: var(--boeing-cyan); text-align: center; }
        .sec-val { color: var(--boeing-white); text-align: right; }
        .sec-val-l { text-align: left; }
    </style>
</head>
<body>

    <div id="loader">CALIBRATING 1:1 AVIONICS...</div>
    <div id="webgl-container"></div>
    <div id="fma-text" class="fma-callouts"></div>

    <div id="cockpit-wrapper">
        <div class="displays-container">
            
            <!-- ================= PFD ================= -->
            <div class="screen pfd">
                <!-- Airspeed Tape -->
                <div class="tape-container" id="spd-tape-clip">
                    <div class="tape-strip" id="spd-strip"></div>
                </div>
                <div class="tape-readout-box spd-box" id="spd-readout">000</div>

                <!-- Attitude Indicator -->
                <div class="attitude-indicator">
                    <div class="horizon-cylinder" id="horizon">
                        <!-- Precise SVG Pitch Ladder -->
                        <svg class="pitch-ladder-svg" viewBox="0 0 140 600">
                            <!-- +20 Deg -->
                            <line x1="30" y1="220" x2="110" y2="220" stroke="white" stroke-width="2"/>
                            <text x="15" y="225" fill="white" font-size="12" font-family="Arimo" font-weight="bold">20</text>
                            <text x="115" y="225" fill="white" font-size="12" font-family="Arimo" font-weight="bold">20</text>
                            <!-- +10 Deg -->
                            <line x1="40" y1="260" x2="100" y2="260" stroke="white" stroke-width="2"/>
                            <text x="25" y="265" fill="white" font-size="12" font-family="Arimo" font-weight="bold">10</text>
                            <text x="105" y="265" fill="white" font-size="12" font-family="Arimo" font-weight="bold">10</text>
                            <!-- Horizon Line -->
                            <line x1="0" y1="300" x2="140" y2="300" stroke="white" stroke-width="3"/>
                            <!-- -10 Deg (Dashed) -->
                            <line x1="40" y1="340" x2="100" y2="340" stroke="white" stroke-width="2" stroke-dasharray="5,5"/>
                            <text x="25" y="345" fill="white" font-size="12" font-family="Arimo" font-weight="bold">10</text>
                            <text x="105" y="345" fill="white" font-size="12" font-family="Arimo" font-weight="bold">10</text>
                        </svg>
                    </div>
                    <div class="aircraft-symbol">
                        <div class="ac-wing left"></div><div class="ac-center"></div><div class="ac-wing right"></div>
                    </div>
                </div>

                <!-- Altitude Tape -->
                <div class="tape-container" id="alt-tape-clip">
                    <div class="tape-strip" id="alt-strip"></div>
                </div>
                <div class="tape-readout-box alt-box" id="alt-readout">00000</div>
            </div>

            <!-- ================= ND ================= -->
            <div class="screen nd">
                <div class="nd-header">
                    <div>GS <span id="gs-readout" style="color:white">0</span></div>
                    <div>TAS <span id="tas-readout" style="color:white">0</span></div>
                </div>
                <div class="nd-header" style="justify-content:center;">
                    <div style="color:white">HDG <span id="hdg-readout" style="color:var(--boeing-green)">090</span>&deg; M</div>
                </div>
                
                <div class="nd-compass-container">
                    <div class="nd-compass-ring" id="nd-compass-container-inner">
                        <svg class="nd-route-svg" viewBox="-150 -150 300 300" style="position:absolute; top:0; left:0; width:100%; height:100%; overflow:visible;">
                            <g id="nd-map-group">
                                <path d="M 0 0 L 0 -280 Q 0 -340 60 -340 L 250 -340" fill="none" stroke="#FF00FF" stroke-width="4" stroke-dasharray="10 6"/>
                                <polygon points="0,-280 6,-274 0,-268 -6,-274" fill="none" stroke="#FF00FF" stroke-width="2"/>
                                <polygon points="60,-340 66,-334 60,-328 54,-334" fill="none" stroke="#FF00FF" stroke-width="2"/>
                            </g>
                        </svg>
                        <div class="nd-compass-rose" id="compass-rose"></div>
                    </div>
                    <div class="nd-ac-symbol"></div>
                </div>
            </div>

            <!-- ================= EIS (1:1 MATCH) ================= -->
            <div class="screen eis">
                <div class="eis-top-row">
                    <span>TAT -12c</span><span class="green">CRZ +42c</span>
                </div>
                
                <!-- N1 Section -->
                <div class="n1-row">
                    <div class="n1-title">N<sub>1</sub></div>
                    
                    <!-- Engine 1 -->
                    <div class="dial-container">
                        <svg class="dial-svg" viewBox="0 0 100 100">
                            <!-- White Arc (Starts ~210 deg, Ends ~ -30 deg) -->
                            <path d="M 15.3 70 A 40 40 0 1 1 84.6 70" fill="none" stroke="#FFFFFF" stroke-width="3"/>
                            <!-- TAI Bug (Green) -->
                            <path d="M 12 55 L 4 55 L 8 48 Z" fill="#00FF00"/>
                            <!-- Max Limit Tick (Red) -->
                            <line x1="82" y1="40" x2="92" y2="40" stroke="#FF0000" stroke-width="3"/>
                            <!-- Dynamic Needle pivoted from center -->
                            <g id="n1-ndl-1-group">
                                <circle cx="50" cy="50" r="4" fill="#FFFFFF"/>
                                <line x1="50" y1="50" x2="16" y2="60" stroke="#FFFFFF" stroke-width="3"/>
                            </g>
                        </svg>
                        <div class="dial-readout" id="n1-val-1">20.0</div>
                    </div>
                    
                    <!-- Engine 2 -->
                    <div class="dial-container">
                        <svg class="dial-svg" viewBox="0 0 100 100">
                            <path d="M 15.3 70 A 40 40 0 1 1 84.6 70" fill="none" stroke="#FFFFFF" stroke-width="3"/>
                            <path d="M 12 55 L 4 55 L 8 48 Z" fill="#00FF00"/>
                            <line x1="82" y1="40" x2="92" y2="40" stroke="#FF0000" stroke-width="3"/>
                            <g id="n1-ndl-2-group">
                                <circle cx="50" cy="50" r="4" fill="#FFFFFF"/>
                                <line x1="50" y1="50" x2="16" y2="60" stroke="#FFFFFF" stroke-width="3"/>
                            </g>
                        </svg>
                        <div class="dial-readout" id="n1-val-2">20.0</div>
                    </div>
                </div>

                <!-- EGT Section -->
                <div class="n1-row" style="margin-top:-20px; transform: scale(0.85);">
                    <div class="n1-title" style="top:55px;">EGT</div>
                    <!-- EGT 1 -->
                    <div class="dial-container">
                        <svg class="dial-svg" viewBox="0 0 100 100">
                            <path d="M 20 80 A 35 35 0 0 1 80 80" fill="none" stroke="#FFFFFF" stroke-width="2"/>
                            <line x1="80" y1="45" x2="90" y2="45" stroke="#FFB800" stroke-width="3"/>
                            <g id="egt-ndl-1-group">
                                <circle cx="50" cy="50" r="3" fill="#FFFFFF"/>
                                <line x1="50" y1="50" x2="22" y2="65" stroke="#FFFFFF" stroke-width="2"/>
                            </g>
                        </svg>
                        <div class="dial-readout" id="egt-val-1" style="font-size: 1.6rem; top: 25px;">410</div>
                    </div>
                    <!-- EGT 2 -->
                    <div class="dial-container">
                        <svg class="dial-svg" viewBox="0 0 100 100">
                            <path d="M 20 80 A 35 35 0 0 1 80 80" fill="none" stroke="#FFFFFF" stroke-width="2"/>
                            <line x1="80" y1="45" x2="90" y2="45" stroke="#FFB800" stroke-width="3"/>
                            <g id="egt-ndl-2-group">
                                <circle cx="50" cy="50" r="3" fill="#FFFFFF"/>
                                <line x1="50" y1="50" x2="22" y2="65" stroke="#FFFFFF" stroke-width="2"/>
                            </g>
                        </svg>
                        <div class="dial-readout" id="egt-val-2" style="font-size: 1.6rem; top: 25px;">410</div>
                    </div>
                </div>

                <!-- Secondary Parameters (Perfect Match to Image) -->
                <div class="secondary-block">
                    <div class="sec-val" id="n2-1">59.0</div>
                    <div class="sec-lbl">N<sub>2</sub></div>
                    <div class="sec-val-l" id="n2-2">59.0 XB</div>

                    <div class="sec-val" id="ff-1">1.20</div>
                    <div class="sec-lbl">FF</div>
                    <div class="sec-val-l" id="ff-2">1.20</div>

                    <div class="sec-val" id="oilp-1">36</div>
                    <div class="sec-lbl">OIL PRESS</div>
                    <div class="sec-val-l" id="oilp-2">36</div>

                    <div class="sec-val" id="oilt-1">120</div>
                    <div class="sec-lbl">OIL TEMP</div>
                    <div class="sec-val-l" id="oilt-2">120</div>

                    <div class="sec-val">14</div>
                    <div class="sec-lbl">OIL QTY</div>
                    <div class="sec-val-l">14 <span style="font-size:0.8rem">LO</span></div>

                    <div class="sec-val" id="vib-1">1.2</div>
                    <div class="sec-lbl">VIB</div>
                    <div class="sec-val-l" id="vib-2">1.2</div>
                </div>

            </div>
        </div>
    </div>

    <div id="scroll-track"></div>

    <script>
        gsap.registerPlugin(ScrollTrigger);

        /* =========================================================
           1. GENERATE PRECISE PFD TAPES
        ========================================================= */
        const spdStrip = document.getElementById('spd-strip');
        const altStrip = document.getElementById('alt-strip');
        const PIXELS_PER_KNOT = 4; // Scale factor for tape sliding
        const PIXELS_PER_FEET = 0.4;

        // Generate Airspeed Tape (0 to 400 knots)
        for(let i = 400; i >= 0; i -= 10) {
            let t = document.createElement('div');
            t.className = 'tick tick-spd';
            t.style.height = (10 * PIXELS_PER_KNOT) + 'px';
            t.innerText = i.toString().padStart(3, '0');
            spdStrip.appendChild(t);
        }

        // Generate Altitude Tape (0 to 40000 ft)
        for(let i = 40000; i >= 0; i -= 100) {
            let t = document.createElement('div');
            t.className = 'tick tick-alt';
            t.style.height = (100 * PIXELS_PER_FEET) + 'px';
            // Only show numbers every 500 ft for cleanliness, tick marks for 100
            t.innerText = (i % 500 === 0) ? i.toString().padStart(4, '0') : '';
            if(i % 500 !== 0) t.style.borderLeft = "2px solid white"; // Smaller tick
            altStrip.appendChild(t);
        }

        // Compass Rose Setup
        const compassRose = document.getElementById('compass-rose');
        const headings = ['N', '03', '06', 'E', '12', '15', 'S', '21', '24', 'W', '30', '33'];
        headings.forEach((hdg, index) => {
            let t = document.createElement('div');
            t.style.position = 'absolute'; t.style.top = '5px'; t.style.left = '50%';
            t.style.transform = `translateX(-50%) rotate(${index * 30}deg) translateY(-130px)`;
            t.style.color = 'white'; t.style.fontWeight = 'bold';
            t.innerText = hdg;
            compassRose.appendChild(t);
        });

        /* =========================================================
           2. PHYSICS STATE & DOM
        ========================================================= */
        const flightState = {
            n1: 20.0, egt: 410, n2: 59.0, ff: 1.2, vib: 1.2,
            airspeed: 0, altitude: 0, pitch: 0, roll: 0, heading: 90,
            gearExtension: 1, worldX: 0, worldZ: 0, fanAngle: 0
        };

        const els = {
            n1_1: document.getElementById('n1-val-1'), n1_2: document.getElementById('n1-val-2'),
            n1_ndl_1: document.getElementById('n1-ndl-1-group'), n1_ndl_2: document.getElementById('n1-ndl-2-group'),
            egt_1: document.getElementById('egt-val-1'), egt_2: document.getElementById('egt-val-2'),
            egt_ndl_1: document.getElementById('egt-ndl-1-group'), egt_ndl_2: document.getElementById('egt-ndl-2-group'),
            n2_1: document.getElementById('n2-1'), n2_2: document.getElementById('n2-2'),
            ff_1: document.getElementById('ff-1'), ff_2: document.getElementById('ff-2'),
            vib_1: document.getElementById('vib-1'), vib_2: document.getElementById('vib-2'),
            
            spd_readout: document.getElementById('spd-readout'), alt_readout: document.getElementById('alt-readout'),
            horizon: document.getElementById('horizon'), hdg: document.getElementById('hdg-readout'), gs: document.getElementById('gs-readout'),
            compassContainer: document.getElementById('nd-compass-container-inner'), nd_route: document.getElementById('nd-map-group'),
            fma: document.getElementById('fma-text')
        };

        /* =========================================================
           3. THREE.JS CYBER ENVIRONMENT (Retained)
        ========================================================= */
        const scene = new THREE.Scene(); scene.background = new THREE.Color('#040914'); scene.fog = new THREE.FogExp2('#040914', 0.003);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 100000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('webgl-container').appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0); dirLight.position.set(100, 200, 100); scene.add(dirLight);

        const grid = new THREE.GridHelper(5000, 100, 0x00E5FF, 0x0a1525); grid.position.y = -5.5; scene.add(grid);
        const rwGeo = new THREE.PlaneGeometry(120, 15000); const rwMat = new THREE.MeshBasicMaterial({ color: 0x080808, side: THREE.DoubleSide });
        const runway = new THREE.Mesh(rwGeo, rwMat); runway.rotation.x = -Math.PI / 2; runway.rotation.z = -Math.PI / 2; runway.position.set(5000, -5.45, 0); scene.add(runway);

        const matBody = new THREE.MeshStandardMaterial({ color: 0xdddddd, roughness: 0.4, polygonOffset: true, polygonOffsetFactor: 1, polygonOffsetUnits: 1 });
        const matDark = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.9, polygonOffset: true, polygonOffsetFactor: 1, polygonOffsetUnits: 1 });
        const wireMat = new THREE.LineBasicMaterial({ color: 0x00E5FF, transparent: true, opacity: 0.25 });

        function applyWireframe(mesh) { mesh.add(new THREE.LineSegments(new THREE.EdgesGeometry(mesh.geometry), wireMat)); }

        const airplane = new THREE.Group(); scene.add(airplane);
        
        // Detailed Fuselage Lathe
        const fusePoints = [new THREE.Vector2(0, 18.5), new THREE.Vector2(0.3, 18.2), new THREE.Vector2(0.9, 17.5), new THREE.Vector2(1.5, 16.5), new THREE.Vector2(1.9, 15.0), new THREE.Vector2(2.0, 12.0), new THREE.Vector2(2.0, -5.0), new THREE.Vector2(1.8, -10.0), new THREE.Vector2(1.3, -14.0), new THREE.Vector2(0.6, -16.8), new THREE.Vector2(0.2, -17.5), new THREE.Vector2(0, -17.5)];
        const fuselage = new THREE.Mesh(new THREE.LatheGeometry(fusePoints, 64).rotateZ(-Math.PI/2), matBody); applyWireframe(fuselage); airplane.add(fuselage);
        const cockpitWindows = new THREE.Mesh(new THREE.CylinderGeometry(1.65, 1.75, 1.2, 16, 1, false, Math.PI * 0.2, Math.PI * 0.6).rotateZ(Math.PI/2), matDark); cockpitWindows.position.set(16.8, 0.4, 0); cockpitWindows.rotation.z = -0.35; airplane.add(cockpitWindows);

        // Wings
        const wingShape = new THREE.Shape(); wingShape.moveTo(3, 0); wingShape.lineTo(-5, 16); wingShape.lineTo(-7, 16); wingShape.lineTo(-2, 5); wingShape.lineTo(-3, 0);
        const wingGeo = new THREE.ExtrudeGeometry(wingShape, { depth: 0.25, bevelEnabled: true, bevelSegments: 2, bevelSize: 0.05, bevelThickness: 0.05 }).rotateX(-Math.PI/2);
        const wingR = new THREE.Mesh(wingGeo, matBody); wingR.position.set(0, -0.8, 0); wingR.rotation.x = 0.08; applyWireframe(wingR); airplane.add(wingR);
        const wingL = new THREE.Mesh(wingGeo.clone().scale(1,1,-1), matBody); wingL.position.set(0, -0.8, 0); wingL.rotation.x = -0.08; applyWireframe(wingL); airplane.add(wingL);

        // Empennage
        const vStabShape = new THREE.Shape(); vStabShape.moveTo(-9, 0); vStabShape.lineTo(-12, 1.5); vStabShape.lineTo(-16, 7.5); vStabShape.lineTo(-18, 7.5); vStabShape.lineTo(-17, 0);
        const vStab = new THREE.Mesh(new THREE.ExtrudeGeometry(vStabShape, {depth: 0.3, bevelEnabled: true, bevelSize: 0.05, bevelThickness: 0.05}).translate(0, 1.5, -0.15), matBody); applyWireframe(vStab); airplane.add(vStab);

        // Engines
        const fans = [];
        function createEngine() {
            const group = new THREE.Group();
            const cowl = new THREE.Mesh(new THREE.CylinderGeometry(1.25, 1.25, 3.8, 32).rotateZ(Math.PI/2), matBody); cowl.scale.set(1, 0.82, 0.95); applyWireframe(cowl); group.add(cowl);
            const fanGroup = new THREE.Group(); fanGroup.position.x = 1.8;
            fanGroup.add(new THREE.Mesh(new THREE.ConeGeometry(0.3, 0.6, 16).rotateZ(-Math.PI/2), matBody));
            const disk = new THREE.Mesh(new THREE.CylinderGeometry(1.1, 1.1, 0.1, 16).rotateZ(Math.PI/2), matDark); applyWireframe(disk); fanGroup.add(disk);
            fanGroup.scale.set(1, 0.82, 0.95); group.add(fanGroup); fans.push(fanGroup);
            return group;
        }
        const engineR = createEngine(); engineR.position.set(2, -2.1, 5.5); airplane.add(engineR);
        const engineL = createEngine(); engineL.position.set(2, -2.1, -5.5); airplane.add(engineL);

        // Landing Gear
        const gearGroup = new THREE.Group(); airplane.add(gearGroup);
        function createMainGear(zOffset) {
            const pivot = new THREE.Group(); pivot.position.set(-3.5, -1.2, zOffset);
            pivot.add(new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 3.5).translate(0, -1.75, 0), matDark));
            const w1 = new THREE.Mesh(new THREE.CylinderGeometry(0.65, 0.65, 0.4, 24).rotateX(Math.PI/2), matDark); w1.position.set(0, -3.5, 0.35); applyWireframe(w1);
            const w2 = new THREE.Mesh(new THREE.CylinderGeometry(0.65, 0.65, 0.4, 24).rotateX(Math.PI/2), matDark); w2.position.set(0, -3.5, -0.35); applyWireframe(w2);
            pivot.add(w1, w2); return pivot;
        }
        const mainGearR = createMainGear(3.6); gearGroup.add(mainGearR);
        const mainGearL = createMainGear(-3.6); gearGroup.add(mainGearL);
        const nosePivot = new THREE.Group(); nosePivot.position.set(14.5, -1.2, 0);
        nosePivot.add(new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 2.5).translate(0, -1.25, 0), matDark));
        gearGroup.add(nosePivot);

        // Speed Dust Particles
        const dustGeo = new THREE.BufferGeometry(); const dustPos = [];
        for(let i=0; i<1000; i++) { dustPos.push((Math.random()-0.5)*1000, Math.random()*200 + 5, (Math.random()-0.5)*500); }
        dustGeo.setAttribute('position', new THREE.Float32BufferAttribute(dustPos, 3));
        const dust = new THREE.Points(dustGeo, new THREE.PointsMaterial({color: 0x00E5FF, size: 1.5, transparent: true, opacity: 0.2})); scene.add(dust);

        /* =========================================================
           4. RENDER LOOP & AVIONICS TRANSLATION
        ========================================================= */
        function render() {
            // EIS N1 & EGT Logic (Mapped accurately to SVG rotation)
            // Range 0-100% maps to roughly -135deg to +135deg rotation
            els.n1_1.innerText = flightState.n1.toFixed(1); els.n1_2.innerText = flightState.n1.toFixed(1);
            let n1Rot = gsap.utils.mapRange(0, 100, -135, 135, flightState.n1);
            // Needles pivot at cx=50, cy=50 in the SVG viewBox
            els.n1_ndl_1.style.transform = `rotate(${n1Rot}deg)`; els.n1_ndl_1.style.transformOrigin = `50px 50px`;
            els.n1_ndl_2.style.transform = `rotate(${n1Rot}deg)`; els.n1_ndl_2.style.transformOrigin = `50px 50px`;

            els.egt_1.innerText = Math.round(flightState.egt); els.egt_2.innerText = Math.round(flightState.egt);
            let egtRot = gsap.utils.mapRange(0, 1000, -135, 135, flightState.egt);
            els.egt_ndl_1.style.transform = `rotate(${egtRot}deg)`; els.egt_ndl_1.style.transformOrigin = `50px 50px`;
            els.egt_ndl_2.style.transform = `rotate(${egtRot}deg)`; els.egt_ndl_2.style.transformOrigin = `50px 50px`;

            // Secondary
            els.n2_1.innerText = flightState.n2.toFixed(1); els.n2_2.innerText = flightState.n2.toFixed(1) + " XB";
            els.ff_1.innerText = flightState.ff.toFixed(2); els.ff_2.innerText = flightState.ff.toFixed(2);
            let vJitter = flightState.n1 > 30 ? (Math.random() * 0.2) : 0;
            els.vib_1.innerText = (flightState.vib + vJitter).toFixed(1); els.vib_2.innerText = (flightState.vib + vJitter).toFixed(1);

            // PFD Tapes (Translate based on scale)
            els.spd_readout.innerText = Math.round(flightState.airspeed).toString().padStart(3, '0');
            els.alt_readout.innerText = Math.round(flightState.altitude).toString().padStart(4, '0');
            
            // The strip starts with 400 at top, 0 at bottom.
            // When speed is 0, we need to translate up to show the bottom.
            let spdOffset = ((400 - flightState.airspeed) * PIXELS_PER_KNOT);
            spdStrip.style.transform = `translateY(-${spdOffset}px)`;
            
            let altOffset = ((40000 - flightState.altitude) * PIXELS_PER_FEET);
            altStrip.style.transform = `translateY(-${altOffset}px)`;

            // Horizon and Pitch Ladder (1 degree = approx 4 pixels)
            let pitchPx = flightState.pitch * 4;
            els.horizon.style.transform = `translateY(${pitchPx}px) rotate(${flightState.roll}deg)`;

            // ND Logic
            let headingRad = -(flightState.heading - 90) * (Math.PI / 180);
            els.gs.innerText = Math.round(flightState.airspeed);
            els.hdg.innerText = Math.round(flightState.heading).toString().padStart(3, '0');
            let hdgDiff = flightState.heading - 90; 
            els.compassContainer.style.transform = `rotate(${-hdgDiff}deg)`;
            els.nd_route.style.transform = `translate(${-flightState.worldZ / 100}px, ${flightState.worldX / 100}px)`;

            // 3D Airplane Physics
            let pivotCompensationY = flightState.altitude < 1 ? -(-3.5) * Math.sin(flightState.pitch * Math.PI/180) : 0;
            airplane.position.set(flightState.worldX, (flightState.altitude * 0.05) + pivotCompensationY, flightState.worldZ);
            airplane.rotation.set(-flightState.roll * (Math.PI/180), headingRad, flightState.pitch * (Math.PI/180), 'YXZ');

            // Mechanics
            mainGearR.rotation.x = (1 - flightState.gearExtension) * (Math.PI / 2);
            mainGearL.rotation.x = -(1 - flightState.gearExtension) * (Math.PI / 2);
            nosePivot.rotation.z = (1 - flightState.gearExtension) * (Math.PI / 2);
            
            flightState.fanAngle -= (flightState.n1 / 100) * 0.5;
            fans.forEach(fan => fan.rotation.x = flightState.fanAngle);

            // Dynamic Orbit Camera
            let rotatedOffsetX = -75 * Math.cos(headingRad) - 50 * Math.sin(headingRad);
            let rotatedOffsetZ = -75 * Math.sin(headingRad) + 50 * Math.cos(headingRad);
            let camX = airplane.position.x + rotatedOffsetX, camY = airplane.position.y + 18, camZ = airplane.position.z + rotatedOffsetZ;

            if(flightState.altitude < 10 && flightState.airspeed > 50) {
                let shake = Math.pow((flightState.airspeed / 160), 2) * 0.5;
                camY += (Math.random() - 0.5) * shake; camX += (Math.random() - 0.5) * shake;
            }
            camera.position.set(camX, camY, camZ);
            camera.lookAt(airplane.position.x + 20 * Math.cos(headingRad), airplane.position.y, airplane.position.z - 20 * Math.sin(headingRad));

            grid.position.x = Math.floor(camera.position.x / 100) * 100; grid.position.z = Math.floor(camera.position.z / 100) * 100;
            dust.position.set(camera.position.x, 0, camera.position.z);

            renderer.render(scene, camera);
            requestAnimationFrame(render);
        }

        /* =========================================================
           5. TIMELINE
        ========================================================= */
        window.onload = () => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').remove(), 1000);
            render();

            const tl = gsap.timeline({ scrollTrigger: { trigger: "#scroll-track", start: "top top", end: "bottom bottom", scrub: 0.5 }});

            tl.addLabel("spool")
              .to(flightState, { n1: 96.0, egt: 663, n2: 81.6, ff: 3.8, duration: 1, ease: "power2.inOut" }, "spool")
              .to(els.fma, { opacity: 1, text: "N1 TO/GA", duration: 0.1 }, "spool+=0.5")
              .to(els.fma, { opacity: 0, duration: 0.2 }, "spool+=1.0");

            tl.addLabel("roll", "+=0.2")
              .to(flightState, { worldX: 4500, duration: 4, ease: "power2.in" }, "roll")
              .to(flightState, { airspeed: 155, duration: 4, ease: "none" }, "roll") 
              .to(els.fma, { opacity: 1, text: "80 KNOTS", duration: 0.1 }, "roll+=1")
              .to(els.fma, { opacity: 0, duration: 0.2 }, "roll+=1.5")
              .to(els.fma, { opacity: 1, text: "V1", duration: 0.1 }, "roll+=3.5")
              .to(els.fma, { opacity: 0, duration: 0.2 }, "roll+=3.8");

            tl.addLabel("rotate", "-=0.2")
              .to(els.fma, { opacity: 1, text: "ROTATE", duration: 0.1 }, "rotate")
              .to(els.fma, { opacity: 0, duration: 0.5 }, "rotate+=0.5")
              .to(flightState, { pitch: 15, duration: 1.5, ease: "power1.inOut" }, "rotate")
              .to(flightState, { worldX: 7500, airspeed: 175, duration: 2, ease: "none" }, "rotate");

            tl.addLabel("climb", "+=0")
              .to(els.fma, { opacity: 1, text: "POSITIVE RATE", duration: 0.1 }, "climb")
              .to(els.fma, { opacity: 0, duration: 0.5 }, "climb+=0.5")
              .to(flightState, { altitude: 1000, duration: 2, ease: "none" }, "climb")
              .to(flightState, { gearExtension: 0, duration: 1 }, "climb+=0.2")
              .to(flightState, { worldX: 12000, airspeed: 195, duration: 2, ease: "none" }, "climb");

            tl.addLabel("turn", "+=0")
              .to(els.fma, { opacity: 1, text: "LNAV ENGAGED", duration: 0.1 }, "turn")
              .to(els.fma, { opacity: 0, duration: 0.5 }, "turn+=1.0")
              .to(flightState, { roll: 25, duration: 1, ease: "power1.inOut" }, "turn")
              .to(flightState, { pitch: 5, altitude: 9000, duration: 6, ease: "power1.out" }, "turn") 
              .to(flightState, { heading: 180, duration: 6, ease: "none" }, "turn")
              .to(flightState, { worldX: 28000 + 6000, duration: 6, ease: "sine.out" }, "turn")
              .to(flightState, { worldZ: 6000, duration: 6, ease: "sine.in" }, "turn")
              .to(flightState, { roll: 0, duration: 1, ease: "power1.inOut" }, "turn+=5");

            tl.addLabel("level", "+=0")
              .to(els.fma, { opacity: 1, text: "ALT HOLD", duration: 0.1 }, "level")
              .to(flightState, { altitude: 10000, worldZ: 6000 + 15000, airspeed: 280, pitch: 2, n1: 75, duration: 4, ease: "none" }, "level");

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };
    </script>
</body>
</html>
